<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat App - Modular</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>">

  <!-- Modular CSS -->
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/reply.css">
  <link rel="stylesheet" href="/css/emoji.css">
  <link rel="stylesheet" href="/css/voice.css">
  <link rel="stylesheet" href="/css/voice.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/toast.css">
  <link rel="stylesheet" href="/css/call.css">

</head>

<body>
  <!-- ================= LOGIN ================= -->
  <div class="login" id="login">
    <div class="login-box">
      <h2>Chat App</h2>
      <input type="email" id="emailInput" placeholder="Enter your email">
      <button onclick="sendMagicLink()">Send Magic Link</button>
      <div class="divider">OR</div>
      <a href="/auth/google" class="google-btn">Login with Google</a>
    </div>

  </div>

  <!-- ================= MAIN APP ================= -->
  <div class="app" id="app" style="display:none">
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div style="display: flex; align-items: center; gap: 10px;">
          <!-- Sidebar Toggle (Hamburger) - closes sidebar -->
          <button class="sidebar-toggle-btn" onclick="app.toggleSidebar()" title="Close Sidebar"
            style="background: transparent; border: none; font-size: 20px; color: var(--text-primary); cursor: pointer;">‚ò∞</button>
          <div style="font-weight: bold;">Chats</div>
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <!-- Saved Items Icon -->
          <button class="new-chat-btn" onclick="switchTab('saved')" title="Saved Items"
            style="background: transparent; color: var(--text-secondary); padding: 5px; font-size: 18px;">üíæ</button>
          <button class="new-chat-btn" onclick="showSettingsModal()"
            style="background: transparent; color: var(--text-secondary); padding: 5px;">‚öôÔ∏è</button>
          <button class="new-chat-btn" onclick="showNewChatModal()">+ New</button>
        </div>
      </div>


      <div class="tab-buttons">
        <button class="tab-btn active" onclick="switchTab('dms')" id="btn-dms">DMs</button>
        <button class="tab-btn" onclick="switchTab('rooms')" id="btn-rooms">Rooms</button>
        <button class="tab-btn" onclick="switchTab('channels')" id="btn-channels">
          Channels
        </button>
      </div>



      <div class="search-bar">
        <input type="text" placeholder="Search..." id="searchInput">
      </div>

      <div class="chat-list" id="chatList"></div>
    </div>

    <!-- CHAT AREA -->
    <div class="chat-area" id="chatArea">
      <div class="chat-header">
        <div class="chat-header-left">
          <!-- Back Button (Mobile Only) -->
          <button class="back-btn" id="mobileBackBtn" onclick="app.showSidebar()"
            style="display: none; background: transparent; border: none; font-size: 20px; color: var(--text-primary); margin-right: 10px; cursor: pointer;">‚Üê</button>

          <!-- Desktop Open Sidebar Button (Visible only when sidebar is closed) -->
          <button class="sidebar-open-btn" id="desktopSidebarToggle" onclick="app.toggleSidebar()"
            style="display: none; background: transparent; border: none; font-size: 20px; color: var(--text-primary); margin-right: 15px; cursor: pointer;">‚ò∞</button>

          <div class="chat-avatar" id="currentChatAvatar"
            style="background: transparent; display: flex; align-items: center; justify-content: center; font-size: 24px;">
            üí¨</div>
          <div>
            <div id="currentChatName">Select a Chat</div>
            <div class="status" id="currentChatStatus"></div>
          </div>
        </div>
        <div class="chat-header-right">
          <button class="header-btn" id="inviteBtn" style="display: none;" onclick="showRoomInviteModal()"
            title="Invite to Room">
            <span>‚ûï Invite</span>
          </button>
        </div>
      </div>

      <div class="chat-messages" id="messages"></div>
      <div class="typing" id="typing"></div>

      <!-- Reply Preview -->
      <div class="reply-preview" id="replyPreview">
        <div class="reply-content">
          <div class="reply-to-label" id="replyToLabel">Reply to User</div>
          <div class="reply-text" id="replyText">Message text...</div>
        </div>
        <button class="reply-close" onclick="replyManager.cancelReply()">&times;</button>
      </div>

      <!-- Voice Recording UI -->
      <div class="voice-recording-ui" id="voiceRecordingUI">
        <div class="recording-indicator"></div>
        <div class="live-waveform" id="liveWaveform"></div>
        <div class="recording-timer" id="recordingTimer">0:00</div>
        <button class="cancel-recording-btn" onclick="voiceManager.cancelRecording()">Cancel</button>
      </div>

      <div class="chat-input" style="display:none;"> <!-- Hidden by default -->
        <div class="emoji-picker" id="emojiPicker"></div>
        <input id="messageInput" placeholder="Type a message">
        <input type="file" id="fileInput" hidden>
        <button class="emoji-btn" onclick="emojiManager.togglePicker()">üòä</button>
        <button class="file-btn" onclick="fileInput.click()">üìé</button>
        <button class="mic-btn" id="micBtn" onmousedown="voiceManager.startRecording()"
          onmouseup="voiceManager.stopRecording()">üé§</button>
        <button class="send-btn" onclick="app.sendMessage()">‚û§</button>
      </div>
    </div>
  </div>

  <!-- ================= MODAL ================= -->
  <div class="modal" id="newChatModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">New Direct Message</div>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody">
        <!-- Dynamic content loaded by JS -->
      </div>
    </div>
  </div>

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- Modular JavaScript -->
  <script type="module" src="/js/reply.js"></script>
  <script type="module" src="/js/editDelete.js"></script>
  <script type="module" src="/js/emoji.js"></script>
  <script type="module" src="/js/voice.js"></script>
  <script src="/js/callManager.js"></script>
  <script type="module" src="/js/toast.js"></script>
  <script type="module" src="/js/app.js"></script>


  <!-- Helper functions for onclick handlers -->
  <script>
    function switchTab(tab) {
      if (window.app) {
        window.app.switchTab(tab);
      }
    }

    function showNewChatModal() {
      if (window.app) {
        window.app.showNewChatModal();
      }
    }

    function closeModal() {
      document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
    }

    function showRoomInviteModal() {
      if (window.app) {
        window.app.showRoomInviteModal();
      }
    }

    function joinRoom(token) {
      window.location.href = `/rooms/join/${token}`;
    }

    function showSettingsModal() {
      if (window.app) window.app.showSettingsModal();
    }

    function saveProfile() {
      if (window.app) window.app.saveProfile();
    }

    async function sendMagicLink() {
      const email = document.getElementById("emailInput").value.trim();
      if (!email) {
        alert("Please enter your email");
        return;
      }

      const btn = document.querySelector('button[onclick="sendMagicLink()"]');
      const originalText = btn.innerText;
      btn.innerText = "Sending...";
      btn.disabled = true;

      try {
        const res = await fetch("/auth/magic-link", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });

        const data = await res.json();

        if (data.success) {
          alert("Magic link sent! Check your email (or server logs if testing locally).");
        } else {
          alert("Error: " + (data.error || "Failed to send link"));
        }
      } catch (err) {
        console.error(err);
        alert("Request failed. Please try again.");
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    }
  </script>

  <!-- Room Invite Modal -->
  <div class="modal" id="roomInviteModal">
    <div class="modal-content">
      <h2>Invite to Room</h2>
      <div id="roomInviteContent"></div>
      <div class="modal-actions">
        <button onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content" style="max-width: 400px;">
      <h2 style="margin-bottom: 20px;">Edit Profile</h2>
      <div id="settingsBody" style="display: flex; flex-direction: column; gap: 20px;">

        <!-- Avatar Section -->
        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
          <div id="settingsAvatarPreview"
            style="width: 100px; height: 100px; border-radius: 50%; background: var(--bg-secondary); color: var(--text-secondary); display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold; overflow: hidden; border: 2px solid var(--border-color);">
            <!-- Img or Initial will be set by JS -->
          </div>
          <label for="settingsAvatar"
            style="cursor: pointer; color: var(--telegram-blue); font-size: 14px; font-weight: 500;">
            Change Profile Photo
          </label>
          <input type="file" id="settingsAvatar" accept="image/*" hidden>
        </div>

        <!-- Name Section -->
        <div>
          <label
            style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 13px; font-weight: 500;">DISPLAY
            NAME</label>
          <input type="text" id="settingsName" placeholder="Your Name"
            style="width: 100%; padding: 12px; background: var(--bg-darker); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 15px;">
        </div>

        <!-- Bio Section -->
        <div>
          <label
            style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 13px; font-weight: 500;">BIO</label>
          <textarea id="settingsBio" placeholder="Add a few words about yourself..." rows="3"
            style="width: 100%; padding: 12px; background: var(--bg-darker); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; resize: none;"></textarea>
        </div>

        <div id="settingsStatus" style="font-size: 13px; min-height: 20px; text-align: center;"></div>

        <!-- Actions -->
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button onclick="closeModal()"
            style="flex: 1; padding: 12px; background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-weight: 500;">Cancel</button>
          <button onclick="saveProfile()"
            style="flex: 1; padding: 12px; background: var(--telegram-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Save</button>
        </div>

      </div>
    </div>
  </div>

</body>

</html>