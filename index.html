<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat App - Modular</title>

  <!-- Modular CSS -->
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/reply.css">
  <link rel="stylesheet" href="/css/emoji.css">
  <link rel="stylesheet" href="/css/voice.css">
  <link rel="stylesheet" href="/css/voice.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/toast.css">

</head>

<body>
  <!-- ================= LOGIN ================= -->
  <div class="login" id="login">
    <div class="login-box">
      <h2>Chat App</h2>
      <input type="email" id="emailInput" placeholder="Enter your email">
      <button onclick="sendMagicLink()">Send Magic Link</button>
      <div class="divider">OR</div>
      <a href="/auth/google" class="google-btn">Login with Google</a>
    </div>

  </div>

  <!-- ================= MAIN APP ================= -->
  <div class="app" id="app" style="display:none">
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div style="display: flex; align-items: center; gap: 10px;">
          <!-- Sidebar Toggle (Hamburger) -->
          <button class="sidebar-toggle-btn" onclick="app.toggleSidebar()"
            style="background: transparent; border: none; font-size: 20px; color: var(--text-primary); cursor: pointer;">‚ò∞</button>
          <div>Chats</div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="new-chat-btn" onclick="showSettingsModal()"
            style="background: transparent; color: var(--text-secondary); padding: 5px;">‚öôÔ∏è</button>
          <button class="new-chat-btn" onclick="showNewChatModal()">+ New</button>
        </div>
      </div>


      <div class="tab-buttons">
        <button class="tab-btn active" onclick="switchTab('channels')" id="btn-channels">
          Channels
        </button>
        <button class="tab-btn" onclick="switchTab('dms')" id="btn-dms">DMs</button>
        <button class="tab-btn" onclick="switchTab('rooms')" id="btn-rooms">Rooms</button>
        <button class="tab-btn" onclick="switchTab('saved')" id="btn-saved">Saved</button>
      </div>



      <div class="search-bar">
        <input type="text" placeholder="Search..." id="searchInput">
      </div>

      <div class="chat-list" id="chatList"></div>
    </div>

    <!-- CHAT AREA -->
    <div class="chat-area" id="chatArea">
      <div class="chat-header">
        <div class="chat-header-left">
          <!-- Back Button (Mobile Only) -->
          <button class="back-btn" id="mobileBackBtn" onclick="app.showSidebar()"
            style="display: none; background: transparent; border: none; font-size: 20px; color: var(--text-primary); margin-right: 10px; cursor: pointer;">‚Üê</button>

          <div class="chat-avatar" id="currentChatAvatar">G</div>
          <div>
            <div id="currentChatName">Community Chat</div>
            <div class="status" id="currentChatStatus">online</div>
          </div>
        </div>
        <div class="chat-header-right">
          <button class="header-btn" id="inviteBtn" style="display: none;" onclick="showRoomInviteModal()"
            title="Invite to Room">
            <span>‚ûï Invite</span>
          </button>
        </div>
      </div>

      <div class="chat-messages" id="messages"></div>
      <div class="typing" id="typing"></div>

      <!-- Reply Preview -->
      <div class="reply-preview" id="replyPreview">
        <div class="reply-content">
          <div class="reply-to-label" id="replyToLabel">Reply to User</div>
          <div class="reply-text" id="replyText">Message text...</div>
        </div>
        <button class="reply-close" onclick="replyManager.cancelReply()">&times;</button>
      </div>

      <!-- Voice Recording UI -->
      <div class="voice-recording-ui" id="voiceRecordingUI">
        <div class="recording-indicator"></div>
        <div class="live-waveform" id="liveWaveform"></div>
        <div class="recording-timer" id="recordingTimer">0:00</div>
        <button class="cancel-recording-btn" onclick="voiceManager.cancelRecording()">Cancel</button>
      </div>

      <div class="chat-input">
        <div class="emoji-picker" id="emojiPicker"></div>
        <input id="messageInput" placeholder="Type a message">
        <input type="file" id="fileInput" hidden>
        <button class="emoji-btn" onclick="emojiManager.togglePicker()">üòä</button>
        <button class="file-btn" onclick="fileInput.click()">üìé</button>
        <button class="mic-btn" id="micBtn" onmousedown="voiceManager.startRecording()"
          onmouseup="voiceManager.stopRecording()">üé§</button>
        <button class="send-btn" onclick="app.sendMessage()">‚û§</button>
      </div>
    </div>
  </div>

  <!-- ================= MODAL ================= -->
  <div class="modal" id="newChatModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">New Direct Message</div>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody">
        <!-- Dynamic content loaded by JS -->
      </div>
    </div>
  </div>

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- Modular JavaScript -->
  <script type="module" src="/js/reply.js"></script>
  <script type="module" src="/js/editDelete.js"></script>
  <script type="module" src="/js/emoji.js"></script>
  <script type="module" src="/js/voice.js"></script>
  <script type="module" src="/js/voice.js"></script>
  <script type="module" src="/js/toast.js"></script>
  <script type="module" src="/js/app.js"></script>


  <!-- Helper functions for onclick handlers -->
  <script>
    function switchTab(tab) {
      if (window.app) {
        window.app.switchTab(tab);
      }
    }

    function showNewChatModal() {
      if (window.app) {
        window.app.showNewChatModal();
      }
    }

    function closeModal() {
      document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
    }

    function showRoomInviteModal() {
      if (window.app) {
        window.app.showRoomInviteModal();
      }
    }

    function joinRoom(token) {
      window.location.href = `/rooms/join/${token}`;
    }

    function showSettingsModal() {
      if (window.app) window.app.showSettingsModal();
    }

    function saveProfile() {
      if (window.app) window.app.saveProfile();
    }
  </script>

  <!-- Room Invite Modal -->
  <div class="modal" id="roomInviteModal">
    <div class="modal-content">
      <h2>Invite to Room</h2>
      <div id="roomInviteContent"></div>
      <div class="modal-actions">
        <button onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <h2>Profile Settings</h2>
      <div id="settingsBody" style="display: flex; flex-direction: column; gap: 15px;">
        <!-- Avatar Preview -->
        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
          <div id="settingsAvatarPreview"
            style="width: 80px; height: 80px; border-radius: 50%; background: var(--telegram-blue); color: white; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; overflow: hidden;">
            <!-- Img or Initial will be set by JS -->
          </div>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 13px;">Display
            Name</label>
          <input type="text" id="settingsName" placeholder="Your Name"
            style="width: 100%; padding: 10px; background: var(--bg-darker); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);">
        </div>

        <div>
          <label
            style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 13px;">Avatar</label>
          <input type="file" id="settingsAvatar" accept="image/*"
            style="width: 100%; padding: 10px; background: var(--bg-darker); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);">
        </div>

        <div id="settingsStatus" style="font-size: 13px; min-height: 20px;"></div>
      </div>
      <div class="modal-actions">
        <button onclick="closeModal()"
          style="background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color);">Cancel</button>
        <button onclick="saveProfile()" style="background: var(--telegram-blue); color: white;">Save Changes</button>
      </div>
    </div>
  </div>

</body>

</html>