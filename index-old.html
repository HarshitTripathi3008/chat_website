<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat App</title>

  <style>
    /* ===== BASE STYLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    body {
      font-family: "Segoe UI", sans-serif;
      background: #0b141a;
      height: 100vh;
      overflow: hidden;
    }

    /* ===== LAYOUT ===== */
    .app {
      display: flex;
      height: 100vh
    }

    .sidebar {
      width: 30%;
      background: #111b21;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #2a3942
    }

    .sidebar-header {
      padding: 15px;
      background: #202c33;
      color: #e9edef;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      padding: 10px 15px;
      background: #111b21;
      border-bottom: 1px solid #2a3942
    }

    .tab-btn {
      padding: 8px 16px;
      background: #2a3942;
      border: none;
      color: #8696a0;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s
    }

    .tab-btn.active {
      background: #00a884;
      color: white
    }

    .chat-list {
      flex: 1;
      overflow-y: auto
    }

    .chat-item {
      display: flex;
      gap: 10px;
      padding: 12px 15px;
      cursor: pointer;
      color: #e9edef;
      position: relative;
      transition: background 0.2s
    }

    .chat-item:hover {
      background: #2a3942
    }

    .chat-item.active {
      background: #2a3942
    }

    .chat-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: #00a884;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      color: white;
      position: relative
    }

    .online-dot {
      width: 12px;
      height: 12px;
      background: #00a884;
      border-radius: 50%;
      position: absolute;
      bottom: 0;
      right: 0;
      border: 2px solid #111b21
    }

    .chat-info {
      flex: 1;
      min-width: 0
    }

    .chat-name {
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    .chat-last {
      font-size: 12px;
      color: #8696a0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 3px
    }

    .unread-badge {
      background: #00a884;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600
    }

    .new-chat-btn {
      background: #00a884;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px
    }

    /* ===== CHAT AREA ===== */
    .chat-area {
      width: 70%;
      display: flex;
      flex-direction: column;
      background: #0b141a
    }

    .chat-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      background: #202c33;
      color: #e9edef;
      justify-content: space-between
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .status {
      font-size: 12px;
      color: #00a884
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: url("https://static.vecteezy.com/system/resources/previews/002/188/833/original/chat-wallpaper-social-media-message-background-copy-space-for-a-text-vector.jpg")
    }

    .message {
      max-width: 65%;
      padding: 10px 14px;
      margin-bottom: 10px;
      border-radius: 8px;
      font-size: 14px;
      word-wrap: break-word;
      position: relative;
      animation: slideIn 0.2s ease-out
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .sent {
      background: #005c4b;
      color: white;
      margin-left: auto
    }

    .received {
      background: #202c33;
      color: #e9edef
    }

    .message-time {
      font-size: 10px;
      opacity: .7;
      margin-top: 4px;
      text-align: right
    }

    .message-reactions {
      display: flex;
      gap: 4px;
      margin-top: 6px;
      flex-wrap: wrap
    }

    .reaction {
      background: #2a3942;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      transition: all 0.2s
    }

    .reaction:hover {
      background: #374955
    }

    .reaction.my-reaction {
      background: #005c4b
    }

    .reaction-emoji {
      font-size: 14px
    }

    .reaction-count {
      font-size: 11px;
      color: #8696a0
    }

    .message-actions {
      position: absolute;
      top: -25px;
      right: 0;
      background: #202c33;
      border-radius: 8px;
      padding: 4px;
      display: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      gap: 4px;
    }

    .message:hover .message-actions {
      display: flex
    }

    .action-btn {
      background: none;
      border: none;
      color: #8696a0;
      cursor: pointer;
      padding: 4px 8px;
      font-size: 16px;
      transition: all 0.2s
    }

    .action-btn:hover {
      color: #00a884
    }

    /* ===== REPLY STYLES ===== */
    .reply-preview {
      background: #2a3942;
      padding: 8px 12px;
      margin: 8px;
      border-left: 3px solid #00a884;
      border-radius: 4px;
      display: none;
      align-items: center;
      justify-content: space-between;
    }

    .reply-preview.show {
      display: flex;
    }

    .reply-content {
      flex: 1;
    }

    .reply-to-label {
      font-size: 11px;
      color: #00a884;
      font-weight: 600;
    }

    .reply-text {
      font-size: 13px;
      color: #8696a0;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .reply-close {
      background: none;
      border: none;
      color: #8696a0;
      cursor: pointer;
      font-size: 18px;
      padding: 0 4px;
    }

    .message-reply {
      background: #1a2832;
      padding: 6px 10px;
      margin-bottom: 6px;
      border-left: 3px solid #00a884;
      border-radius: 4px;
      cursor: pointer;
    }

    .message-reply:hover {
      background: #243642;
    }

    .message-reply-label {
      font-size: 11px;
      color: #00a884;
      font-weight: 600;
    }

    .message-reply-text {
      font-size: 12px;
      color: #8696a0;
      margin-top: 2px;
    }

    /* ===== EDIT STYLES ===== */
    .edited-label {
      font-size: 10px;
      color: #8696a0;
      font-style: italic;
      margin-left: 4px;
    }

    .edit-input {
      width: 100%;
      padding: 8px;
      background: #2a3942;
      border: 1px solid #00a884;
      border-radius: 4px;
      color: white;
      font-size: 14px;
      font-family: inherit;
      outline: none;
    }

    .edit-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      justify-content: flex-end;
    }

    .edit-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .edit-save {
      background: #00a884;
      color: white;
    }

    .edit-cancel {
      background: #2a3942;
      color: #e9edef;
    }

    /* ===== DELETE STYLES ===== */
    .deleted-message {
      opacity: 0.6;
      font-style: italic;
      color: #8696a0;
    }

    /* ===== FORWARD STYLES ===== */
    .forwarded-label {
      font-size: 11px;
      color: #00a884;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .typing {
      padding: 5px 20px;
      font-size: 12px;
      color: #8696a0
    }

    /* ===== INPUT AREA ===== */
    .chat-input {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #202c33;
      position: relative
    }

    .chat-input input {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: none;
      outline: none;
      background: #2a3942;
      color: white
    }

    .send-btn {
      background: #00a884;
      border: none;
      color: white;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s
    }

    .send-btn:hover {
      background: #06a47a
    }

    .file-btn,
    .emoji-btn {
      background: #2a3942;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s
    }

    .file-btn:hover,
    .emoji-btn:hover {
      background: #374955
    }

    /* ===== EMOJI PICKER ===== */
    .emoji-picker {
      position: absolute;
      bottom: 60px;
      left: 10px;
      background: #202c33;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      display: none;
      width: 320px;
      max-height: 300px;
      overflow-y: auto
    }

    .emoji-picker.show {
      display: block
    }

    .emoji-category {
      margin-bottom: 10px
    }

    .emoji-category-title {
      color: #8696a0;
      font-size: 11px;
      margin-bottom: 5px;
      text-transform: uppercase
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px
    }

    .emoji-item {
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      text-align: center;
      border-radius: 4px;
      transition: all 0.2s
    }

    .emoji-item:hover {
      background: #2a3942;
      transform: scale(1.2)
    }

    /* ===== REACTION PICKER ===== */
    .reaction-picker {
      position: absolute;
      bottom: 100%;
      left: 0;
      background: #202c33;
      border-radius: 20px;
      padding: 8px 12px;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      animation: popIn 0.2s ease-out
    }

    @keyframes popIn {
      from {
        opacity: 0;
        transform: scale(0.8)
      }

      to {
        opacity: 1;
        transform: scale(1)
      }
    }

    .reaction-picker.show {
      display: flex;
      gap: 8px
    }

    .reaction-option {
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s
    }

    .reaction-option:hover {
      transform: scale(1.3)
    }

    /* ===== LOGIN ===== */
    .login {
      position: fixed;
      inset: 0;
      background: #0b141a;
      display: flex;
      align-items: center;
      justify-content: center
    }

    .login-box {
      background: #202c33;
      padding: 30px;
      border-radius: 12px;
      width: 300px;
      text-align: center;
      color: white
    }

    .login-box input {
      width: 100%;
      padding: 12px;
      margin: 15px 0;
      border: none;
      border-radius: 8px
    }

    .login-box button {
      width: 100%;
      padding: 12px;
      background: #00a884;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      transition: all 0.2s
    }

    .login-box button:hover {
      background: #06a47a
    }

    /* ===== MODAL ===== */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000
    }

    .modal.show {
      display: flex
    }

    .modal-content {
      background: #202c33;
      padding: 25px;
      border-radius: 12px;
      width: 400px;
      color: white
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600
    }

    .close-btn {
      background: none;
      border: none;
      color: #8696a0;
      font-size: 24px;
      cursor: pointer
    }

    .modal-input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      background: #2a3942;
      color: white
    }

    .modal-btn {
      width: 100%;
      padding: 12px;
      background: #00a884;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.2s
    }

    .modal-btn:hover {
      background: #06a47a
    }

    /* ===== SEARCH ===== */
    .search-bar {
      padding: 10px 15px;
      background: #111b21;
      border-bottom: 1px solid #2a3942
    }

    .search-bar input {
      width: 100%;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      background: #2a3942;
      color: white;
      outline: none
    }

    @media(max-width:900px) {
      .sidebar {
        width: 100%
      }

      .chat-area {
        display: none
      }

      .chat-area.active {
        display: flex;
        width: 100%
      }

      .sidebar.hide {
        display: none
      }
    }
  </style>
</head>

<body>

  <!-- ================= LOGIN ================= -->
  <div class="login" id="login">
    <div class="login-box">
      <h2>Magic Link Login</h2>
      <input id="emailInput" type="email" placeholder="Enter your email">
      <button onclick="sendMagicLink()">Send Login Link</button>
    </div>
  </div>

  <!-- ================= CHAT APP ================= -->
  <div class="app" id="app" style="display:none">

    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span id="sidebarTitle">Chats</span>
        <button class="new-chat-btn" onclick="showNewChatModal()">+ New</button>
      </div>

      <div class="tab-buttons">
        <button class="tab-btn active" onclick="switchTab('global')">Global</button>
        <button class="tab-btn" onclick="switchTab('dms')">DMs</button>
        <button class="tab-btn" onclick="switchTab('rooms')">Rooms</button>
      </div>

      <div class="search-bar">
        <input type="text" placeholder="Search..." id="searchInput" oninput="filterChats()">
      </div>

      <div class="chat-list" id="chatList"></div>
    </div>

    <div class="chat-area" id="chatArea">
      <div class="chat-header">
        <div class="chat-header-left">
          <div class="chat-avatar" id="currentChatAvatar">G</div>
          <div>
            <div id="currentChatName">Global Chat</div>
            <div class="status" id="currentChatStatus">online</div>
          </div>
        </div>
      </div>

      <div class="chat-messages" id="messages"></div>
      <div class="typing" id="typing"></div>

      <!-- Reply Preview -->
      <div class="reply-preview" id="replyPreview">
        <div class="reply-content">
          <div class="reply-to-label" id="replyToLabel">Reply to User</div>
          <div class="reply-text" id="replyText">Message text...</div>
        </div>
        <button class="reply-close" onclick="cancelReply()">&times;</button>
      </div>

      <div class="chat-input">
        <div class="emoji-picker" id="emojiPicker"></div>
        <input id="messageInput" placeholder="Type a message">
        <input type="file" id="fileInput" hidden>
        <button class="emoji-btn" onclick="toggleEmojiPicker()">ðŸ˜Š</button>
        <button class="file-btn" onclick="fileInput.click()">ðŸ“Ž</button>
        <button class="send-btn" onclick="sendMessage()">âž¤</button>
      </div>
    </div>

  </div>

  <!-- ================= NEW CHAT MODAL ================= -->
  <div class="modal" id="newChatModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">New Direct Message</div>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket;
    let me;
    let currentConversation = { type: 'global', id: null };
    let conversations = [];
    let onlineUsers = [];
    let currentTab = 'global';

    /* ================= EMOJI DATA ================= */
    const emojiCategories = {
      'Smileys': ['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ¤£', 'ðŸ˜‚', 'ðŸ™‚', 'ðŸ™ƒ', 'ðŸ˜‰', 'ðŸ˜Š', 'ðŸ˜‡', 'ðŸ¥°', 'ðŸ˜', 'ðŸ¤©', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜š', 'ðŸ˜™', 'ðŸ¥²', 'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ˜', 'ðŸ¤‘', 'ðŸ¤—', 'ðŸ¤­', 'ðŸ¤«', 'ðŸ¤”', 'ðŸ¤', 'ðŸ¤¨', 'ðŸ˜', 'ðŸ˜‘', 'ðŸ˜¶', 'ðŸ˜', 'ðŸ˜’', 'ðŸ™„', 'ðŸ˜¬', 'ðŸ¤¥', 'ðŸ˜Œ', 'ðŸ˜”', 'ðŸ˜ª', 'ðŸ¤¤', 'ðŸ˜´', 'ðŸ˜·', 'ðŸ¤’', 'ðŸ¤•', 'ðŸ¤¢', 'ðŸ¤®', 'ðŸ¤§', 'ðŸ¥µ', 'ðŸ¥¶', 'ðŸ¥´', 'ðŸ˜µ', 'ðŸ¤¯', 'ðŸ¤ ', 'ðŸ¥³', 'ðŸ¥¸', 'ðŸ˜Ž', 'ðŸ¤“', 'ðŸ§'],
      'Gestures': ['ðŸ‘', 'ðŸ‘Ž', 'ðŸ‘Œ', 'âœŒï¸', 'ðŸ¤ž', 'ðŸ¤Ÿ', 'ðŸ¤˜', 'ðŸ¤™', 'ðŸ‘ˆ', 'ðŸ‘‰', 'ðŸ‘†', 'ðŸ‘‡', 'â˜ï¸', 'âœ‹', 'ðŸ¤š', 'ðŸ–ï¸', 'ðŸ––', 'ðŸ‘‹', 'ðŸ¤', 'ðŸ™', 'ðŸ’ª', 'ðŸ¦¾', 'ðŸ¦¿', 'ðŸ¦µ', 'ðŸ¦¶', 'ðŸ‘‚', 'ðŸ¦»', 'ðŸ‘ƒ', 'ðŸ§ ', 'ðŸ«€', 'ðŸ«', 'ðŸ¦·', 'ðŸ¦´', 'ðŸ‘€', 'ðŸ‘ï¸', 'ðŸ‘…', 'ðŸ‘„'],
      'Hearts': ['â¤ï¸', 'ðŸ§¡', 'ðŸ’›', 'ðŸ’š', 'ðŸ’™', 'ðŸ’œ', 'ðŸ–¤', 'ðŸ¤', 'ðŸ¤Ž', 'ðŸ’”', 'â£ï¸', 'ðŸ’•', 'ðŸ’ž', 'ðŸ’“', 'ðŸ’—', 'ðŸ’–', 'ðŸ’˜', 'ðŸ’', 'ðŸ’Ÿ'],
      'Objects': ['ðŸ’¬', 'ðŸ’­', 'ðŸ—¨ï¸', 'ðŸ—¯ï¸', 'ðŸ’¤', 'ðŸ’¢', 'ðŸ’£', 'ðŸ’¥', 'ðŸ’¦', 'ðŸ’¨', 'ðŸ’«', 'ðŸ’¬', 'ðŸ•³ï¸', 'ðŸ’£', 'ðŸ’¢']
    };

    const quickReactions = ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ™'];

    /* ================= AUTO LOGIN ================= */
    fetch("/me")
      .then(res => {
        if (!res.ok) throw new Error();
        return res.json();
      })
      .then(user => {
        me = user;
        login.style.display = "none";
        app.style.display = "flex";
        initApp();
      })
      .catch(() => {
        login.style.display = "flex";
        app.style.display = "none";
      });

    /* ================= INIT APP ================= */
    function initApp() {
      initEmojiPicker();
      loadConversations();
      loadOnlineUsers();
      loadHistory();
      initSocket();
    }

    /* ================= EMOJI PICKER ================= */
    function initEmojiPicker() {
      const picker = document.getElementById('emojiPicker');
      let html = '';
      for (const [category, emojis] of Object.entries(emojiCategories)) {
        html += `<div class="emoji-category">
      <div class="emoji-category-title">${category}</div>
      <div class="emoji-grid">
        ${emojis.map(e => `<span class="emoji-item" onclick="insertEmoji('${e}')">${e}</span>`).join('')}
      </div>
    </div>`;
      }
      picker.innerHTML = html;
    }

    function toggleEmojiPicker() {
      document.getElementById('emojiPicker').classList.toggle('show');
    }

    function insertEmoji(emoji) {
      const input = document.getElementById('messageInput');
      input.value += emoji;
      input.focus();
    }

    /* ================= TAB SWITCHING ================= */
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      if (tab === 'global') {
        currentConversation = { type: 'global', id: null };
        loadHistory();
        updateChatHeader('Global Chat', 'online', 'G');
      }

      loadConversations();
    }

    /* ================= CONVERSATIONS ================= */
    function loadConversations() {
      if (currentTab === 'global') {
        chatList.innerHTML = '';
        return;
      }

      fetch(`/conversations?type=${currentTab === 'dms' ? 'direct' : 'group'}`)
        .then(res => res.json())
        .then(convs => {
          conversations = convs;
          renderConversations();
        });
    }

    function renderConversations() {
      const html = conversations.map(conv => {
        const otherUser = conv.participants.find(p => p._id !== me._id);
        const name = conv.type === 'direct' ? otherUser?.name : conv.name;
        const avatar = getAvatar(name);
        const unread = conv.unreadCount?.get(me._id) || 0;

        return `<div class="chat-item ${conv._id === currentConversation.id ? 'active' : ''}" onclick="openConversation('${conv._id}')">
      <div class="chat-avatar">${avatar}</div>
      <div class="chat-info">
        <div class="chat-name">
          <span>${name}</span>
          ${unread > 0 ? `<span class="unread-badge">${unread}</span>` : ''}
        </div>
        <div class="chat-last">${conv.lastMessage?.text || 'No messages yet'}</div>
      </div>
    </div>`;
      }).join('');

      chatList.innerHTML = html;
    }

    function openConversation(convId) {
      const conv = conversations.find(c => c._id === convId);
      if (!conv) return;

      currentConversation = { type: conv.type, id: convId };

      const otherUser = conv.participants.find(p => p._id !== me._id);
      const name = conv.type === 'direct' ? otherUser?.name : conv.name;
      const status = conv.type === 'direct' ? (isUserOnline(otherUser?._id) ? 'online' : 'offline') : `${conv.participants.length} members`;

      updateChatHeader(name, status, getAvatar(name));
      loadConversationMessages(convId);
      renderConversations();
    }

    function loadConversationMessages(convId) {
      fetch(`/conversations/${convId}/messages`)
        .then(res => res.json())
        .then(msgs => {
          messages.innerHTML = '';
          msgs.forEach(addMessage);
        });
    }

    function updateChatHeader(name, status, avatar) {
      document.getElementById('currentChatName').textContent = name;
      document.getElementById('currentChatStatus').textContent = status;
      document.getElementById('currentChatAvatar').textContent = avatar;
    }

    /* ================= ONLINE USERS ================= */
    function loadOnlineUsers() {
      fetch("/online-users")
        .then(res => res.json())
        .then(users => {
          onlineUsers = users;
          if (currentTab === 'global') {
            renderOnlineUsers();
          }
        });
    }

    function renderOnlineUsers() {
      const html = onlineUsers.map(u =>
        `<div class="chat-item">
      <div class="chat-avatar">
        ${getAvatar(u.name)}
        <div class="online-dot"></div>
      </div>
      <div class="chat-info">
        <div class="chat-name">${u.name}</div>
      </div>
    </div>`
      ).join('');
      chatList.innerHTML = html;
    }

    function isUserOnline(userId) {
      return onlineUsers.some(u => u._id === userId);
    }

    /* ================= CHAT HISTORY ================= */
    function loadHistory() {
      fetch("/messages")
        .then(res => res.json())
        .then(msgs => {
          messages.innerHTML = '';
          msgs.forEach(addMessage);
        });
    }

    /* ================= SOCKET.IO ================= */
    function initSocket() {
      socket = io();

      socket.on("me", user => {
        me = user;
      });

      socket.on("message", addMessage);

      socket.on("userTyping", d => {
        typing.innerText = d.username + " is typing...";
      });

      socket.on("userStoppedTyping", () => {
        typing.innerText = "";
      });

      socket.on("reaction", updateReaction);

      socket.on("onlineUsers", users => {
        onlineUsers = users;
        if (currentTab === 'global') renderOnlineUsers();
      });
    }

    /* ================= REPLY STATE ================= */
    let replyingTo = null;

    /* ================= SEND MESSAGE ================= */
    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;

      const data = { text };
      if (currentConversation.id) {
        data.conversationId = currentConversation.id;
      }

      // Add reply data if replying
      if (replyingTo) {
        data.replyTo = {
          messageId: replyingTo._id,
          text: replyingTo.text,
          username: replyingTo.username
        };
      }

      socket.emit("message", data);
      messageInput.value = "";
      document.getElementById('emojiPicker').classList.remove('show');
      cancelReply(); // Clear reply state
    }

    /* ================= REPLY FUNCTIONS ================= */
    function startReply(messageId, username, text) {
      replyingTo = { _id: messageId, username, text };

      document.getElementById('replyToLabel').textContent = `Reply to ${username}`;
      document.getElementById('replyText').textContent = text;
      document.getElementById('replyPreview').classList.add('show');
      document.getElementById('messageInput').focus();
    }

    function cancelReply() {
      replyingTo = null;
      document.getElementById('replyPreview').classList.remove('show');
    }

    function jumpToMessage(messageId) {
      const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
      if (messageEl) {
        messageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        messageEl.style.backgroundColor = '#2a3942';
        setTimeout(() => {
          messageEl.style.backgroundColor = '';
        }, 1000);
      }
    }

    /* ================= EDIT FUNCTIONS ================= */
    function startEdit(messageId, currentText) {
      const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
      if (!messageEl) return;

      const textContainer = messageEl.querySelector('.message-text');
      if (!textContainer) return;

      const originalHTML = textContainer.innerHTML;

      textContainer.innerHTML = `
        <input type="text" class="edit-input" value="${currentText}" id="editInput-${messageId}">
        <div class="edit-actions">
          <button class="edit-btn edit-cancel" onclick="cancelEdit('${messageId}', \`${originalHTML.replace(/`/g, '\\`')}\`)">Cancel</button>
          <button class="edit-btn edit-save" onclick="saveEdit('${messageId}')">Save</button>
        </div>
      `;

      document.getElementById(`editInput-${messageId}`).focus();
    }

    function cancelEdit(messageId, originalHTML) {
      const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
      if (!messageEl) return;

      const textContainer = messageEl.querySelector('.message-text');
      if (textContainer) {
        textContainer.innerHTML = originalHTML;
      }
    }

    function saveEdit(messageId) {
      const newText = document.getElementById(`editInput-${messageId}`).value.trim();
      if (!newText) return;

      socket.emit('editMessage', { messageId, newText });
    }

    /* ================= DELETE FUNCTIONS ================= */
    function deleteMessage(messageId, deleteForEveryone = false) {
      const confirmed = confirm(deleteForEveryone ?
        'Delete this message for everyone?' :
        'Delete this message for you?');

      if (confirmed) {
        socket.emit('deleteMessage', { messageId, deleteForEveryone });
      }
    }

    /* ================= FILE UPLOAD ================= */
    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file) return;

      const fd = new FormData();
      fd.append("file", file);
      if (currentConversation.id) {
        fd.append("conversationId", currentConversation.id);
      }

      fetch("/upload", {
        method: "POST",
        body: fd
      });

      fileInput.value = "";
    });

    /* ================= TYPING INDICATOR ================= */
    messageInput.addEventListener("input", () => {
      socket.emit("typing");
    });

    messageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    /* ================= RENDER MESSAGE ================= */
    function addMessage(data) {
      const div = document.createElement("div");
      const isMine = data.userId === me._id;

      div.className = "message " + (isMine ? "sent" : "received");
      div.dataset.messageId = data._id;

      let content = '';

      if (data.type === "image") {
        content = `
      ${!isMine ? `<b>${data.username}</b><br>` : ""}
      <img src="${data.file.url}" style="max-width:200px;border-radius:6px">
    `;
      } else if (data.type === "file") {
        content = `
      ${!isMine ? `<b>${data.username}</b><br>` : ""}
      <a href="${data.file.url}" download style="color:#00a884">${data.file.name}</a>
    `;
      } else {
        content = `
      ${!isMine ? `<b>${data.username}</b><br>` : ""}
      ${data.text}
    `;
      }

      const reactionsHtml = renderReactions(data.reactions || []);

      div.innerHTML = `
    <div class="message-actions">
      <button class="action-btn" onclick="showReactionPicker('${data._id}')">ðŸ˜Š</button>
    </div>
    ${content}
    <div class="message-time">${new Date(data.createdAt || Date.now()).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</div>
    ${reactionsHtml}
  `;

      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function renderReactions(reactions) {
      if (!reactions || reactions.length === 0) return '';

      const html = reactions.map(r => {
        const isMine = r.users.some(u => u === me._id || u._id === me._id);
        return `<span class="reaction ${isMine ? 'my-reaction' : ''}" onclick="toggleReaction('${r.emoji}', '${r._id}')">
      <span class="reaction-emoji">${r.emoji}</span>
      <span class="reaction-count">${r.users.length}</span>
    </span>`;
      }).join('');

      return `<div class="message-reactions">${html}</div>`;
    }

    /* ================= REACTIONS ================= */
    function showReactionPicker(messageId) {
      const existing = document.querySelector('.reaction-picker');
      if (existing) existing.remove();

      const picker = document.createElement('div');
      picker.className = 'reaction-picker show';
      picker.innerHTML = quickReactions.map(e =>
        `<span class="reaction-option" onclick="addReaction('${messageId}', '${e}')">${e}</span>`
      ).join('');

      const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
      messageEl.style.position = 'relative';
      messageEl.appendChild(picker);

      setTimeout(() => {
        document.addEventListener('click', function closePickerHandler(e) {
          if (!picker.contains(e.target)) {
            picker.remove();
            document.removeEventListener('click', closePickerHandler);
          }
        });
      }, 100);
    }

    function addReaction(messageId, emoji) {
      socket.emit('reaction', { messageId, emoji });
      document.querySelector('.reaction-picker')?.remove();
    }

    function updateReaction(data) {
      const messageEl = document.querySelector(`[data-message-id="${data.messageId}"]`);
      if (!messageEl) return;

      const reactionsContainer = messageEl.querySelector('.message-reactions');
      if (reactionsContainer) {
        reactionsContainer.outerHTML = renderReactions(data.reactions);
      } else {
        const timeEl = messageEl.querySelector('.message-time');
        timeEl.insertAdjacentHTML('afterend', renderReactions(data.reactions));
      }
    }

    /* ================= NEW CHAT MODAL ================= */
    function showNewChatModal() {
      const modal = document.getElementById('newChatModal');
      const modalBody = document.getElementById('modalBody');

      if (currentTab === 'dms') {
        document.getElementById('modalTitle').textContent = 'New Direct Message';
        modalBody.innerHTML = `
      <div class="search-bar"><input type="text" placeholder="Search users..." id="userSearch" oninput="searchUsers()"></div>
      <div id="userList"></div>
    `;
        loadAllUsers();
      } else if (currentTab === 'rooms') {
        document.getElementById('modalTitle').textContent = 'Create Room';
        modalBody.innerHTML = `
      <input type="text" class="modal-input" id="roomName" placeholder="Room name">
      <input type="text" class="modal-input" id="roomDesc" placeholder="Description (optional)">
      <button class="modal-btn" onclick="createRoom()">Create Room</button>
    `;
      }

      modal.classList.add('show');
    }

    function closeModal() {
      document.getElementById('newChatModal').classList.remove('show');
    }

    function loadAllUsers() {
      fetch('/users')
        .then(res => res.json())
        .then(users => {
          const html = users.filter(u => u._id !== me._id).map(u =>
            `<div class="chat-item" onclick="startDM('${u._id}')">
          <div class="chat-avatar">${getAvatar(u.name)}</div>
          <div class="chat-info">
            <div class="chat-name">${u.name}</div>
          </div>
        </div>`
          ).join('');
          document.getElementById('userList').innerHTML = html;
        });
    }

    function startDM(userId) {
      fetch('/conversations/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
      })
        .then(res => res.json())
        .then(conv => {
          closeModal();
          loadConversations();
          openConversation(conv._id);
        });
    }

    function createRoom() {
      const name = document.getElementById('roomName').value.trim();
      const description = document.getElementById('roomDesc').value.trim();

      if (!name) return alert('Room name required');

      fetch('/rooms/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, description })
      })
        .then(res => res.json())
        .then(room => {
          closeModal();
          switchTab('rooms');
          loadConversations();
        });
    }

    /* ================= HELPERS ================= */
    function getAvatar(name) {
      if (!name) return '?';
      return name.charAt(0).toUpperCase();
    }

    function filterChats() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      document.querySelectorAll('.chat-item').forEach(item => {
        const name = item.querySelector('.chat-name').textContent.toLowerCase();
        item.style.display = name.includes(search) ? 'flex' : 'none';
      });
    }

    /* ================= MAGIC LINK ================= */
    function sendMagicLink() {
      const email = emailInput.value.trim();
      if (!email) return alert("Enter email");

      fetch("/auth/magic-link", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      }).then(() => alert("Check your email for login link"));
    }

    // Close emoji picker when clicking outside
    document.addEventListener('click', (e) => {
      const picker = document.getElementById('emojiPicker');
      const emojiBtn = document.querySelector('.emoji-btn');
      if (picker && !picker.contains(e.target) && e.target !== emojiBtn) {
        picker.classList.remove('show');
      }
    });
  </script>

</body>

</html>